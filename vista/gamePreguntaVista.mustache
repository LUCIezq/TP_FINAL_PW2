<link rel="stylesheet" href="/public/assets/barraTiempo.css">
{{#message}}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    {{message}}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{/message}}

<div class="container text-center py-5">
    <div class="barra-tiempo-container">
    <div id="barra-tiempo"></div>
</div>

<div id="timer" class="timer-display">20s</div>
    <div class="bg-light p-4 rounded-3 mb-4" style="display: flex; flex-direction: column; align-items: center;">
        <div class="dropdown" style="align-self: flex-end;">
            <button type="button" style="border: none; background: transparent;" data-bs-toggle="dropdown"
                aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" style="cursor:pointer;" width="16" height="16"
                    fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                    <path
                        d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                </svg>
            </button>
            <ul class="dropdown-menu">
                <button type="button" style="width:100%; border: none; background: transparent;" data-bs-toggle="modal"
                    data-bs-target="#exampleModal">
                    <li><a class="dropdown-item" href="#">Reportar</a></li>
                </button>
            </ul>
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Reportar pregunta</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="/reporte/reportar" method="post">
                            <div class="mb-3">
                                <label for="motivo" class="form-label">Motivo del reporte:</label>
                                <select class="form-select" id="motivo" name="motivo" required>
                                    <option value="" selected disabled>Seleccione un motivo</option>
                                    <option value="Inexactitud">Respuesta/s incorrectas</option>
                                    <option value="Ofensivo">Ofensivo</option>
                                    <option value="Spam">Spam</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="detalle" class="form-label">Detalle (opcional):</label>
                                <textarea class="form-control" id="detalle" name="detalle" rows="3"></textarea>
                            </div>
                            <input type="hidden" name="pregunta_id" value="{{pregunta.id}}">
                            <input type="hidden" name="usuario_id" value="{{usuario_id}}">

                            <div class="mt">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Enviar reporte</button>
                            </div>
                        </form>

                    </div>

                </div>
            </div>
        </div>
        <p class="fs-5 font-weight-bold">{{pregunta.texto}}</p>
    </div>
 
    <form id="formPregunta" method="POST" action="/game/respuesta">
        <input type="hidden" name="partida_id" value="{{partida_id}}">
        <input type="hidden" name="pregunta_id" value="{{pregunta.id}}">
        
        <div class="d-grid gap-3 col-6 mx-auto mt-4">
            {{#respuestas}}
            <button type="button" class="btn btn-outline-primary btn-lg opcion-respuesta" data-id="{{id}}"
                data-texto="{{texto}}">
                {{texto}}
            </button>
            {{/respuestas}}
        </div>
    </form>

    <div id="mensaje" class="mt-5 fs-4 fw-bold"></div>
</div>

<script>
    let tiempo = 20;
    const DURACION = 20;

    const tiempoDiv = document.getElementById("timer");
    const barraTiempo = document.getElementById("barra-tiempo");
    const botonesRespuestas = document.querySelectorAll(".opcion-respuesta");
    const form = document.getElementById("formPregunta");
    const mensajeDiv = document.getElementById("mensaje");

    function actualizarTimer() {

        // Mostrar texto del cron√≥metro
        tiempoDiv.innerText = tiempo + "s";

        // ---- BARRA ----
        let porcentaje = (tiempo / DURACION) * 100;
        barraTiempo.style.width = porcentaje + "%";

        // Color din√°mico
        if (tiempo > 10) {
            barraTiempo.style.background = "#28a745"; // verde
        } else if (tiempo > 5) {
            barraTiempo.style.background = "#ffc107"; // amarillo
        } else {
            barraTiempo.style.background = "#dc3545"; // rojo
        }

        // ---- TIEMPO AGOTADO ----
        if (tiempo <= 0) {

            barraTiempo.style.width = "0%";
            tiempoDiv.innerText = "‚è≥ Tiempo agotado";

            botonesRespuestas.forEach(b => b.disabled = true);

            const formData = new FormData(form);
            formData.append("respuesta_id", -1);
            formData.append("timeout", 1);  // üî• Correcto ahora

            fetch("/game/respuesta", {
                method: "POST",
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                mensajeDiv.innerHTML =
                    "‚è≥ Se acab√≥ el tiempo.<br>La respuesta correcta era:<br><strong>" +
                    data.correcta_texto +
                    "</strong>";

                setTimeout(() => window.location.href = "/home", 3000);
            });

            clearInterval(intervalo);
        }

        tiempo--;
    }

    const intervalo = setInterval(actualizarTimer, 1000);

    // ===== CLICK EN RESPUESTAS =====
    const botones = document.querySelectorAll(".opcion-respuesta");

    botones.forEach(btn => {
        btn.addEventListener("click", () => {

            botones.forEach(b => b.disabled = true);
            clearInterval(intervalo);

            const formData = new FormData(form);
            formData.append("respuesta_id", btn.dataset.id);

            fetch("/game/respuesta", {
                method: "POST",
                body: formData
            })
            .then(r => r.json())
            .then(data => {

                if (data.fin) {
                    mensajeDiv.innerHTML = "üéâ ¬°Partida completada!";
                    setTimeout(() => window.location.href = "/home", 2500);
                    return;
                }

                if (data.correcta === true && data.continuar) {
                    btn.classList.add("btn-success");
                    mensajeDiv.innerHTML = "‚úÖ ¬°Correcto!";
                    setTimeout(() => window.location.href = "/game/siguientePregunta", 1500);
                    return;
                }

                if (data.correcta === false) {
                    btn.classList.add("btn-danger");
                    mensajeDiv.innerHTML =
                        "‚ùå Incorrecto.<br>La respuesta correcta era:<br><strong>" +
                        data.correcta_texto +
                        "</strong>";
                    setTimeout(() => window.location.href = "/home", 3000);
                    return;
                }

                mensajeDiv.innerHTML = "‚ö† Error inesperado.";
            })
            .catch(() => mensajeDiv.innerHTML = "Error con el servidor");
        });
    });
</script>


<!--<script>
    let tiempo = 20;
    const tiempoDiv = document.getElementById("timer");
    const botonesRespuestas = document.querySelectorAll(".opcion-respuesta");

    function actualizarTimer() {
        tiempoDiv.innerText = tiempo + "s";

        if (tiempo <= 0) {
            botonesRespuestas.forEach(b => b.disabled = true);

            tiempoDiv.innerText = "‚è≥ Tiempo agotado";

            const form = document.getElementById("formPregunta");
            const formData = new FormData(form);
            formData.append("respuesta_id", 0); 

            fetch("/game/respuesta", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const mensajeDiv = document.getElementById("mensaje");
                mensajeDiv.innerHTML =
                    "‚è≥ Se acab√≥ el tiempo.<br>La respuesta correcta era:<br><strong>" +
                    data.correcta_texto +
                    "</strong>";

                setTimeout(() => window.location.href = "/home", 3000);
            });

            clearInterval(intervalo);
        }

        tiempo--;
    }

    const intervalo = setInterval(actualizarTimer, 1000);

    const botones = document.querySelectorAll(".opcion-respuesta");
    const form = document.getElementById("formPregunta");
    const mensajeDiv = document.getElementById("mensaje");

    botones.forEach(btn => {
        btn.addEventListener("click", () => {
            botones.forEach(b => b.disabled = true);
            clearInterval(intervalo); 

            const formData = new FormData(form);
            formData.append("respuesta_id", btn.dataset.id);

            fetch("/game/respuesta", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.fin) {
                        mensajeDiv.innerHTML = "üéâ ¬°Partida completada! Felicitaciones.";
                        setTimeout(() => window.location.href = "/home", 2500);
                        return;
                    }
                    if (data.correcta === true && data.continuar) {
                        btn.classList.remove("btn-outline-primary");
                        btn.classList.add("btn-success");
                        mensajeDiv.innerHTML = "‚úÖ ¬°Correcto!";
                        setTimeout(() => {
                            window.location.href = "/game/siguientePregunta";
                        }, 1500);
                        return;
                    }
                    if (data.correcta === false) {
                        btn.classList.remove("btn-outline-primary");
                        btn.classList.add("btn-danger");
                        mensajeDiv.innerHTML = "‚ùå Incorrecto. La respuesta correcta era:<br><strong>" 
                                                + data.correcta_texto + "</strong>";
                        setTimeout(() => window.location.href = "/home", 3000);
                        return;
                    }
                    mensajeDiv.innerHTML = "‚ö† Error inesperado. Respuesta no reconocida.";
                })
                .catch(err => {
                    console.error(err);
                    mensajeDiv.innerHTML = "Error con el servidor";
                });
        });
    });
<link rel="stylesheet" href="/public/assets/barraTiempo.css">
</script> -->
